<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨˜å¸³ï½œå¿«é€Ÿè¼¸å…¥</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header class="topbar">
  <div class="wrap topbar__inner">
    <div class="brand">
      <div class="brand__title">è¨˜å¸³</div>
      <div class="brand__sub">å¿«é€Ÿè¼¸å…¥ï¼šå“å / é‡‘é¡ / èª°ä»˜çš„ï½œè‡ªå‹•åˆè¨ˆï¼ˆæœ¬æ©Ÿç€è¦½å™¨ï¼‰</div>
    </div>
    <nav class="nav">
      <a class="nav__link" href="index.html">Home</a>
      <a class="nav__link" href="day1.html">Day 1</a>
      <a class="nav__link" href="day2.html">Day 2</a>
      <a class="nav__link" href="day3.html">Day 3</a>
      <a class="nav__link" href="day4.html">Day 4</a>
      <a class="nav__link" href="day5.html">Day 5</a>
      <a class="nav__link" href="day6.html">Day 6</a>
      <a class="nav__link" href="checklist.html">æ¸…å–®</a>
      <a class="nav__link" href="ledger.html">è¨˜å¸³</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="dayHead">
    <h1 class="dayHead__title">å¿«é€Ÿè¨˜å¸³</h1>
    <div class="dayHead__sub">â• è¼¸å…¥å³ä¿å­˜ï½œğŸ“Š è‡ªå‹•åˆè¨ˆï½œâ¬‡ï¸ å¯åŒ¯å‡º CSV</div>
  </div>

  <section>
    <div class="section-header h-trans">ğŸ§¾ æ–°å¢ä¸€ç­†</div>
    <div class="section-card">
      <div class="grid3">
        <input id="name" class="smallInput" placeholder="å“åï¼ˆä¾‹ï¼šåˆé¤ã€è»Šç¥¨ã€è—¥å¦ã€ä¼´æ‰‹ç¦®â€¦ï¼‰" />
        <input id="amount" class="smallInput" inputmode="numeric" placeholder="é‡‘é¡ï¼ˆÂ¥ï¼‰" />
        <select id="payer" class="smallInput">
          <option value="æˆ‘">æˆ‘</option>
          <option value="æ—…ä¼´">æ—…ä¼´</option>
          <option value="å…±åŒ">å…±åŒ</option>
        </select>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="add" class="btn">â• åŠ å…¥</button>
        <button id="export" class="btn secondary">â¬‡ï¸ åŒ¯å‡º CSV</button>
        <button id="reset" class="btn secondary">â™»ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        <span class="badge">æç¤ºï¼šè³‡æ–™å­˜æ–¼æœ¬æ©Ÿç€è¦½å™¨ï¼ˆæ›æ‰‹æ©Ÿä¸æœƒåŒæ­¥ï¼‰</span>
      </div>

      <div class="kv">
        <div class="kv__left">
          <p class="kv__k">ğŸ§¾ ç¸½æ”¯å‡º</p>
          <p class="kv__v"><span id="total">Â¥0</span></p>
        </div>
        <div class="badges">
          <span class="badge badge--money">æˆ‘ï¼š<span id="sumMe">Â¥0</span></span>
          <span class="badge">æ—…ä¼´ï¼š<span id="sumBuddy">Â¥0</span></span>
          <span class="badge">å…±åŒï¼š<span id="sumBoth">Â¥0</span></span>
        </div>
      </div>
    </div>
  </section>

  <section style="margin-top:14px;">
    <div class="section-header h-food">ğŸ“’ æ˜ç´°</div>
    <div class="section-card">
      <table class="table">
        <thead>
          <tr>
            <th style="width:120px;">æ—¥æœŸ</th>
            <th>å“å</th>
            <th style="width:110px;">èª°ä»˜çš„</th>
            <th style="width:120px;" class="right">é‡‘é¡</th>
            <th style="width:90px;"></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </section>

  <footer class="footer">
    <div class="footer__inner">
      <a href="checklist.html">â† å»æ¸…å–®</a><span class="sep">Â·</span>
      <a href="index.html">Home â†’</a>
    </div>
  </footer>
</main>

<script src="script.js"></script>
<script>
  const KEY = "jp2026_ledger_v1";

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return [];
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    }catch{ return []; }
  }
  function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }

  let list = load();

  const $name = document.getElementById("name");
  const $amount = document.getElementById("amount");
  const $payer = document.getElementById("payer");
  const $add = document.getElementById("add");
  const $export = document.getElementById("export");
  const $reset = document.getElementById("reset");
  const $rows = document.getElementById("rows");

  const $total = document.getElementById("total");
  const $sumMe = document.getElementById("sumMe");
  const $sumBuddy = document.getElementById("sumBuddy");
  const $sumBoth = document.getElementById("sumBoth");

  function fmtYen(n){
    const v = Number(n || 0);
    return "Â¥" + v.toLocaleString("ja-JP");
  }

  function today(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function render(){
    $rows.innerHTML = "";

    let total = 0, me = 0, buddy = 0, both = 0;

    if(list.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="muted" colspan="5">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚ä¸Šé¢è¼¸å…¥ä¸€ç­†å°±æœƒè‡ªå‹•å‡ºç¾åœ¨é€™è£¡ã€‚</td>`;
      $rows.appendChild(tr);
    }

    list.forEach(item => {
      total += item.amount;
      if(item.payer === "æˆ‘") me += item.amount;
      if(item.payer === "æ—…ä¼´") buddy += item.amount;
      if(item.payer === "å…±åŒ") both += item.amount;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="muted">${item.date}</td>
        <td>${escapeHtml(item.name)}</td>
        <td>${escapeHtml(item.payer)}</td>
        <td class="right"><strong>${fmtYen(item.amount)}</strong></td>
        <td class="right"><button class="btn secondary" data-del="${item.id}" style="padding:6px 10px;">åˆªé™¤</button></td>
      `;
      tr.querySelector('[data-del]').addEventListener("click", () => {
        list = list.filter(x => x.id !== item.id);
        save(list);
        render();
      });
      $rows.appendChild(tr);
    });

    $total.textContent = fmtYen(total);
    $sumMe.textContent = fmtYen(me);
    $sumBuddy.textContent = fmtYen(buddy);
    $sumBoth.textContent = fmtYen(both);
  }

  function add(){
    const name = $name.value.trim();
    const amount = Number(String($amount.value).replace(/[^\d.]/g,""));
    const payer = $payer.value;

    if(!name || !Number.isFinite(amount) || amount <= 0) return;

    list.unshift({
      id: crypto.randomUUID(),
      date: today(),
      name,
      payer,
      amount: Math.round(amount)
    });

    save(list);
    $name.value = "";
    $amount.value = "";
    $name.focus();
    render();
  }

  $add.addEventListener("click", add);
  [$name, $amount].forEach(el => el.addEventListener("keydown", (e) => {
    if(e.key === "Enter") add();
  }));

  $reset.addEventListener("click", () => {
    list = [];
    save(list);
    render();
  });

  $export.addEventListener("click", () => {
    const header = ["date","name","payer","amount"];
    const lines = [header.join(",")].concat(
      list.map(x => [
        x.date,
        csvSafe(x.name),
        csvSafe(x.payer),
        x.amount
      ].join(","))
    );
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "jp-ledger.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  function csvSafe(s){
    const str = String(s ?? "");
    if(/[,"\n]/.test(str)) return `"${str.replace(/"/g,'""')}"`;
    return str;
  }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  render();
</script>
</body>
</html>
